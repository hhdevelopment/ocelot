<!DOCTYPE html>
<html>
	<head>
		<title>Page de test</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="ocelot-services.js" type="text/javascript"></script>
		<script src="ocelot-core.js" type="text/javascript"></script>
	</head>
	<body>
		<script>
         var ocelotServices = new OcelotServices();
         ocelotController.addOpenListener(function (event) {
            ocelotServices.subscribe("ocelot-status").message(function (msg) {
               var status = document.getElementById("status");
               if (msg === "OPEN") {
                  status.src = "https://img.shields.io/badge/WebSocket-opened-green.svg";
               } else {
                  status.src = "https://img.shields.io/badge/WebSocket-closed-red.svg";
               }
            });
         });
         var pojoService = new TestPojoService();
         var ejbService = new TestEJBService();
         function getErrorMessage(srv) {
            srv.getMessage(true).then(addMessage).catch(showError);
         }
         function getMessage(srv) {
            srv.getMessage(Math.floor(Math.random() * 10)).then(addMessage).catch(showError);
         }
         function getMessageCached(srv) {
            srv.getMessageCached().then(addMessage).catch(showError);
         }
         function getMessageCached2(srv) {
            srv.getMessageCached2(1, {"id": "5"}, Math.random(), 5, true).then(addMessage).catch(showError);
         }
         function getMessageAndCleanCache(srv) {
            srv.getMessageCachedAndCleanCache({"id": "5"}, 1, Math.random(), 5, true).then(addMessage).catch(showError);
         }
         function getMessage2(srv) {
            srv.getMessage("" + Math.floor(Math.random() * 10)).then(addMessage).catch(showError);
         }
         function showError(fault) {
            alert(fault.message + "\n" + fault.classname + "\n" + fault.stacktrace.join('\n'));
         }
         function addMessage(msg) {
            var output = document.getElementById("output");
            var pre = document.createElement("p");
            pre.style.wordWrap = "break-word";
            pre.innerHTML = msg;
            output.appendChild(pre);
         }

         function myTopic(sub) {
            if (sub) {
               ocelotServices.subscribe("mytopic").message(addMessage);
            } else {
               ocelotServices.unsubscribe("mytopic")
            }
         }
         function showObject() {
            var obj = eval(document.getElementById("testobject").value);
            document.getElementById("objectarea").textContent = JSON.stringify(obj).replace(/,/g, ",\n");
         }
         ocelotServices.getLocale().then(function (locale) {
            var localeSelector = document.getElementById("localeSelector");
            for (i = 0; i < localeSelector.options.length; i++) {
               var currentLocale = JSON.parse(localeSelector.options[i].value);
               if (currentLocale.language === locale.language && currentLocale.country === locale.country) {
                  localeSelector.options.selectedIndex = i;
                  break;
               }
            }
         });
         function changeLocale() {
            var localeSelector = document.getElementById("localeSelector");
            var idx = localeSelector.options.selectedIndex;
            var currentLocale = JSON.parse(localeSelector.options[idx].value);
            ocelotServices.setLocale(currentLocale).then(function (msg) {
               location.reload();
            });
         }
         function getLocale() {
            ejbService.getLanguageLocale().then(function(lg) {
					alert(lg);
				});
         }
         function execCode() {
            eval(document.getElementById("objectarea").value);
         }
		</script>
		<img id="status"/>
		<input id="testobject" type="text" value="document.location"/>
		<select id="localeSelector" onchange="changeLocale()">
			<option value='{"language":"fr","country":"FR"}' selected>fr</option>
			<option value='{"language":"en","country":"US"}'>en</option>
		</select>
		<button onclick="showObject()">SHOW OBJECT</button><br>
		<textarea style="height:200px;width:100%" id="objectarea"></textarea><br>
		<button onclick="execCode()">EXEC</button><br>
		<button onclick="ocelotController.close()">CLOSE WS</button>
		<button onclick="ocelotController.open()">OPEN WS</button><br>
		<button onclick="myTopic(true);">SUBSCRIBE</button><button onclick="myTopic(false);">UNSUBSCRIBE</button><br>
		<button onclick="localStorage.clear()">CLEARCACHE</button><br>
		<button onclick="getMessage(ejbService)">GET EJB MESSAGE(int)</button><button onclick="getMessage2(ejbService)">GET EJB MESSAGE(str)</button><br>
		<button onclick="getMessageCached(ejbService)">GET EJB MESSAGE CACHED 1Mn</button><br>
		<button onclick="getMessageCached2(ejbService)">GET EJB MESSAGE2 CACHED 1Mn</button><button onclick="getMessageAndCleanCache(ejbService)">GET EJB MESSAGE AND CLEAN CACHE2 1Mn</button><br>
		<button onclick="getMessage(pojoService)">GET POJO MESSAGE(int)</button><br>
		<button onclick="getMessage2(pojoService)">GET POJO MESSAGE(str)</button><br>
		<button onclick="getLocale()">GET Locale</button><br>
		<button onclick="getErrorMessage(pojoService)">GET ERROR MESSAGE</button><br>
		<div id="output"></div>
	</body>
</html>
